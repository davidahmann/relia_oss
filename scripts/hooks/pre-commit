#!/usr/bin/env bash
set -euo pipefail

require_cmd() {
  local cmd="$1"
  if ! command -v "$cmd" >/dev/null 2>&1; then
    echo "missing required tool: $cmd" >&2
    return 1
  fi
}

files=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.go$' || true)
yaml_files=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(yml|yaml)$' || true)

if [[ -n "$files" ]]; then
  require_cmd gofmt
  require_cmd go
  require_cmd golangci-lint
  require_cmd gosec

  gofmt -w $files
  git add $files

  go vet ./...
  golangci-lint run ./...
  gosec ./...
fi

if [[ -n "$yaml_files" ]]; then
  require_cmd yamllint
  yamllint -d '{extends: default, rules: {line-length: disable}}' $yaml_files
fi
